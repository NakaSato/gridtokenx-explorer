'use client';

import React from 'react';

interface AnchorEventDecoderProps {
    logs: string[];
    programId?: string;
}

export function AnchorEventDecoder({ logs, programId }: AnchorEventDecoderProps) {
    const [decodedEvents, setDecodedEvents] = React.useState<any[]>([]);

    React.useEffect(() => {
        // Extract Anchor events from logs
        const events: any[] = [];
        let currentEvent: any = null;

        logs.forEach((log, idx) => {
            // Anchor events typically have "Program log: " prefix
            if (log.includes('Program log:')) {
                const logContent = log.replace('Program log:', '').trim();

                // Check if it's an event emission
                if (logContent.startsWith('Instruction:')) {
                    const instruction = logContent.replace('Instruction:', '').trim();
                    events.push({
                        data: instruction,
                        index: idx,
                        type: 'instruction',
                    });
                } else if (logContent.startsWith('Event:')) {
                    // Anchor event
                    const eventData = logContent.replace('Event:', '').trim();
                    try {
                        const parsed = JSON.parse(eventData);
                        events.push({
                            data: parsed,
                            index: idx,
                            type: 'event',
                        });
                    } catch {
                        events.push({
                            data: eventData,
                            index: idx,
                            type: 'event',
                        });
                    }
                } else if (logContent.includes('Trade') || logContent.includes('Energy')) {
                    // Custom energy trading events
                    events.push({
                        data: logContent,
                        index: idx,
                        type: 'custom',
                    });
                }
            } else if (log.includes('Program data:')) {
                // Could be base64 encoded event data
                const data = log.replace('Program data:', '').trim();
                events.push({
                    data,
                    index: idx,
                    type: 'data',
                });
            }
        });

        setDecodedEvents(events);
    }, [logs]);

    if (decodedEvents.length === 0) {
        return null;
    }

    return (
        <div className="mb-4">
            <h5 className="border-bottom pb-2">ðŸŽ¯ Decoded Events & Instructions ({decodedEvents.length})</h5>
            <div className="alert alert-info">
                <strong>Energy Trading Events:</strong> Monitor your platform's energy trades, settlements, and user
                actions
            </div>

            {decodedEvents.map((event, idx) => (
                <div key={idx} className="card mb-2">
                    <div className="card-body">
                        <div className="flex justify-between align-items-start mb-2">
                            <div>
                                {event.type === 'instruction' && (
                                    <span className="badge bg-primary m2">Instruction</span>
                                )}
                                {event.type === 'event' && <span className="badge bg-success m2">Event</span>}
                                {event.type === 'custom' && <span className="badge bg-warning m2">Custom Log</span>}
                                {event.type === 'data' && <span className="badge bg-info m2">Data</span>}
                                <small className="text-muted">Log #{event.index}</small>
                            </div>
                        </div>

                        {typeof event.data === 'object' ? (
                            <pre className="bg-light p-2 rounded mb-0">{JSON.stringify(event.data, null, 2)}</pre>
                        ) : (
                            <div className="font-mono small">
                                <code>{event.data}</code>
                            </div>
                        )}

                        {/* Energy Trading Specific Interpretation */}
                        {(event.data.toString().toLowerCase().includes('energy') ||
                            event.data.toString().toLowerCase().includes('trade') ||
                            event.data.toString().toLowerCase().includes('kwh') ||
                            event.data.toString().toLowerCase().includes('seller') ||
                            event.data.toString().toLowerCase().includes('buyer')) && (
                            <div className="alert alert-success mt-2 mb-0">
                                <small>
                                    <strong>âš¡ Energy Trading Event Detected!</strong> This log likely represents a
                                    trade, settlement, or platform action in your P2P energy marketplace.
                                </small>
                            </div>
                        )}
                    </div>
                </div>
            ))}

            <div className="alert alert-secondary mt-3">
                <h6 className="alert-heading">ðŸ’¡ Tips for Energy Trading Developers:</h6>
                <ul className="mb-0 small">
                    <li>
                        Use <code>msg!</code> macro in Rust to emit custom logs
                    </li>
                    <li>
                        Emit events with <code>#[event]</code> attribute for structured data
                    </li>
                    <li>Include trade details: buyer, seller, amount, price, timestamp</li>
                    <li>Log settlement confirmations and escrow releases</li>
                    <li>Track energy meter readings and verification events</li>
                </ul>
            </div>
        </div>
    );
}
